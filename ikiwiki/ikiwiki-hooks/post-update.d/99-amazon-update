#!/usr/bin/env perl

use warnings;
use strict;

use File::Find::Rule;

use File::Which qw(which);
use Carp qw(croak);


my $s3cmd = 's3cmd';
my $site_path = "$ENV{HOME}/public_html";
my $site_name = 'TylerCipriani';
my $bucket = 'tylercipriani.com';

# Name of subpath in site
my $bucket_prefix = '';

my @cssfiles = ('local.css', 'style.css', 'static/css/merkel-dag-d3.css');

sub jsonfiles {
    my $jsonfiles = File::Find::Rule->file()->name('*.json');
    my $common_path = $site_path . '/' . $site_name;

    if ( not $bucket_prefix =~ /\/$/) {
        $bucket_prefix .= '/';
    }

    my @cmd = ($s3cmd, 'modify');
    push(@cmd, "--add-header='Content-type:application/json'");

    foreach my $jsonfile ($jsonfiles->in($common_path)) {
        if ( $jsonfile =~ s/^$common_path\/// ) {
            my $jsons3 = 's3://' . $bucket . $bucket_prefix . $jsonfile;
            system(join(' ', @cmd) . ' ' . $jsons3 . ' >/dev/null 2>&1');
        }
    }
}

sub update {
    chdir($site_path);
    if ( not -f "$site_name/index.html" ) {
        die("Could not find $site_name/index.html in $site_path");
    }

    if ( not $bucket_prefix ) {
        $bucket_prefix = '/';
    }

    if ( not $bucket_prefix =~ /\/$/) {
        $bucket_prefix .= '/';
    }

    my @cmd = ($s3cmd, 'sync');
    push(@cmd, "--add-header='Expires:max-age=604800'");
    push(@cmd, "--exclude '.git/*'");
    push(@cmd, "--exclude 'ikiwiki.cgi'");
    push(@cmd, "--exclude 'robots.txt'");
    push(@cmd, "--acl-public");
    push(@cmd, $site_name . '/');
    push(@cmd, 's3://' . $bucket . $bucket_prefix);
    push(@cmd, '>/dev/null');
    push(@cmd, '2>&1');

    system(join(' ', @cmd));

    my @csscmd = ($s3cmd, 'setacl');
    push(@csscmd, '--acl-public', "--mime-type='text/css'");

    my @cssheaderscmd = ($s3cmd, 'modify');
    push(@cssheaderscmd, "--add-header='Content-type:text/css'");

    foreach my $css (@cssfiles) {
        my $s3css = 's3://' . $bucket . $bucket_prefix . $css;
        system(join(' ', @csscmd) . ' ' . $s3css . ' >/dev/null 2>&1');
        system(join(' ', @cssheaderscmd) . ' ' . $s3css . ' >/dev/null 2>&1');
    }

    jsonfiles;
}

sub main {
    $s3cmd = which($s3cmd);

    if ( not -x "$s3cmd" ) {
        croak("Couldn't find s3cmd");
    }

    update;
}

main;
