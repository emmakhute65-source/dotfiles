#!/usr/bin/env bash

help() {
  cat<<DOC
  Usage: $(basename $0) (sync|mount|umount)
DOC
}

mount() {
  if mountpoint -q '.backup/crypt'; then
    echo "crypt is mounted"
  else
    echo "mounting crypt"
    sshfs -o uid=$(id -u) -o gid=$(id -g) -o idmap=user -o allow_other tyler@home.tylercipriani.com:/volume1/homes/tyler/backup "$HOME/.backup/crypt"
  fi

  if mountpoint -q '.backup/clear'; then
    echo "clear is mounted"
  else
    echo "mounting clear"
    encfs "$HOME/.backup/crypt/" "$HOME/.backup/clear/"
  fi

  echo "clear and crypt are mounted"
}

umount() {
  fusermount -u "$HOME/.backup/clear"
  fusermount -u "$HOME/.backup/crypt"
}

setup() {
  sudo apt-get install sshfs encfs unison
  mkdir -p "$HOME/.backup/{crypt,clear}"
  mkdir -p "$HOME/backup"
}

sync() {
  unison -auto "$HOME/backup/" "$HOME/.backup/clear/"
  # rsync -avzO "$HOME/backup/." "$HOME/.backup/clear/."
}

main() {
  if (( $# != 1 )); then
    help
    exit 1
  fi

  case $1 in
    sync)
      sync
      ;;
    mount)
      mount
      ;;
    umount)
      umount
      ;;
    setup)
      setup
      ;;
    *)
      help
      exit 1
      ;;
  esac
}

main "$@"