#!/usr/bin/env python2

import os
import sys
import subprocess

import click


script = os.path.realpath(__file__)
root = os.path.dirname(os.path.dirname(script))
src = os.path.join(root, 'lib')

sys.path.append(src)

import hiraeth


@click.group(context_settings={'help_option_names': ['-h', '--help']})
def cli():
    """Git photo

    This is a photo manager that is integrated with git and git-annex
    """


@cli.command()
@click.argument('path-to-add')
def addpath(**kwargs):
    """Add path to index publishing."""
    path_to_add = os.path.realpath(os.path.expanduser(kwargs['path_to_add']))
    kwargs['is_index'] = False
    cfg = hiraeth.Config(root, kwargs)
    cfg.add_path(path_to_add)


@cli.group()
def publish():
    """Publish photos to the web."""
    pass


@publish.command()
@click.argument('path')
@click.argument('public')
def gallery(**kwargs):
    """Publish directory as a gallery."""
    kwargs['is_index'] = False
    app = hiraeth.App(hiraeth.Config(root, kwargs))
    sys.exit(app.main())


@publish.command()
@click.argument('path')
@click.argument('public')
def index(**kwargs):
    """Publish index of known galleries."""
    kwargs['is_index'] = True
    app = hiraeth.App(hiraeth.Config(root, kwargs))
    sys.exit(app.main(index_page=True))


@cli.command()
@click.argument('path')
def add(**kwargs):
    """Generate and add metadata to a git-annex photo."""
    kwargs['is_index'] = False
    photo = hiraeth.Pic(kwargs['path'], hiraeth.Config(root, kwargs))
    print photo.exif


@cli.command()
@click.argument('path', nargs=-1)
@click.argument('public', nargs=1)
def thumbs(**kwargs):
    """Generate thumbs for PATH output to PUBLIC."""
    kwargs['is_index'] = False

    # In case a wildcard is passed
    for path in kwargs['path']:
        subprocess.check_call([script, 'add', path])
        args = kwargs
        args['path'] = path

        photo = hiraeth.Pic(path, hiraeth.Config(root, args))
        photo.make_thumbs()


@cli.command()
def setup(**kwargs):
    """
    Initialize git photo for a directory.

    Adds $PWD to git config photos.path.path
    """
    cfg = hiraeth.Config(root, kwargs)
    cfg.setup()

if __name__ == '__main__':
    cli()
